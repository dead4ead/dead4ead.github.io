---
title: STUN
description: stun for nat detect
author: dead4ead
date: 2026-02-01 12:00:00 +0800
categories: [Network, STUN]
tags: [STUN, NAT]
#pin: true
math: true
mermaid: true
---

## STUN探测类型
### Mapping行为（NatBehavior）
决定：公网映射端口是否稳定、是否与对端有关  

| Behavior 枚举                    | 标准术语 | 含义                                         |
| -------------------------------- | -------- | -------------------------------------------- |
| DirectMapping                    | 无 NAT   | 无地址/端口转换                               |
| EndpointIndependentMapping       | EIM      | 同一内网 IP:Port → 同一公网 IP:Port（与对端无关） |
| AddressDependentMapping          | ADM      | 映射依赖对端 IP                              |
| AddressAndPortDependentMapping   | APDM     | 映射依赖对端 IP + Port                       |

### Filtering行为（FilterBehavior）
决定：外部“谁”能主动打进来  

| Filtering 枚举                     | 标准术语 | 含义                  |
| ---------------------------------- | -------- | --------------------- |
| DirectConnectionFiltering          | 无过滤   | 任意外部可直连        |
| EndpointIndependentFiltering       | EIF      | 任意端口，只要 IP 匹配即可 |
| AddressDependentFiltering          | ADF      | 需 IP 匹配            |
| AddressAndPortDependentFiltering   | APDF     | 需 IP + Port 都匹配   |

## 映射到四大NAT类型  

| Mapping（Behavior）              | Filtering                        | NAT 类型                       |
| ------------------------------ | -------------------------------- | ---------------------------- |
| EndpointIndependentMapping     | EndpointIndependentFiltering     | **Full Cone NAT**            |
| EndpointIndependentMapping     | AddressDependentFiltering        | **Restricted Cone NAT**      |
| EndpointIndependentMapping     | AddressAndPortDependentFiltering | **Port Restricted Cone NAT** |
| AddressDependentMapping        | *任意*                             | **Symmetric NAT**            |
| AddressAndPortDependentMapping | *任意*                             | **Symmetric NAT**            |
| DirectMapping                  | DirectConnectionFiltering        | **Open Internet（无 NAT）**     |

> 只要 Mapping 不是 Endpoint Independent，一律判定为 Symmetric NAT   
过滤方式在 Symmetric NAT 场景下已经“无实用价值”

### Full Cone NAT
**特征**
* 映射固定
* 无过滤（任何外部都能打进） 
 
Mapping   = EndpointIndependentMapping   
Filtering = EndpointIndependentFiltering

### Restricted Cone NAT
**特征**
* 映射固定
* 只限制对端 IP，不限制端口

Mapping   = EndpointIndependentMapping   
Filtering = AddressDependentFiltering  
 
### Port Restricted Cone NAT
**特征**
* 映射固定
* 同时限制对端 IP + Port

Mapping   = EndpointIndependentMapping   
Filtering = AddressAndPortDependentFiltering  

### Symmetric NAT
**特征**
* 映射随对端变化,映射依赖对端 IP + Port

Mapping = AddressDependentMapping   
Mapping = AddressAndPortDependentMapping  

### 代码
```cpp
enum NatType {
    Nat_OpenInternet,
    Nat_FullCone,
    Nat_RestrictedCone,
    Nat_PortRestrictedCone,
    Nat_Symmetric,
    Nat_Unknown
};

NatType DetectNatType(NatBehavior mapping, NatFiltering filtering)
{
    if (mapping == DirectMapping)
        return Nat_OpenInternet;

    if (mapping != EndpointIndependentMapping)
        return Nat_Symmetric;

    switch (filtering)
    {
        case EndpointIndependentFiltering:
            return Nat_FullCone;
        case AddressDependentFiltering:
            return Nat_RestrictedCone;
        case AddressAndPortDependentFiltering:
            return Nat_PortRestrictedCone;
        default:
            return Nat_Unknown;
    }
}

```