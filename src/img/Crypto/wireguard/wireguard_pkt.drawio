<mxfile host="Electron" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/26.0.4 Chrome/128.0.6613.186 Electron/32.2.5 Safari/537.36" version="26.0.4">
  <diagram name="第 1 页" id="QKV-rdRZpvzflmU7z-4i">
    <mxGraphModel dx="3524" dy="2234" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="SK4sQwNGuHgdbQXASSQb-1" value="&lt;div&gt;&lt;span class=&quot;fontstyle0&quot;&gt;Initiator&lt;/span&gt;&lt;br style=&quot;font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-variant-position: normal; line-height: normal; text-align: -webkit-auto; text-size-adjust: auto;&quot;&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry y="200" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-2" value="&lt;span class=&quot;fontstyle0&quot;&gt;Responder&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="560" y="200" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-3" value="" style="endArrow=none;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-4" target="SK4sQwNGuHgdbQXASSQb-1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="387" y="495" as="sourcePoint" />
            <mxPoint x="437" y="445" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-4" value="&lt;div&gt;&lt;span class=&quot;fontstyle0&quot;&gt;Initiator&lt;/span&gt;&lt;br style=&quot;font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-variant-position: normal; line-height: normal; text-align: -webkit-auto; text-size-adjust: auto;&quot;&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry y="1628" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-5" value="&lt;span class=&quot;fontstyle0&quot;&gt;Responder&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="560" y="1628" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-6" value="" style="endArrow=none;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-5" target="SK4sQwNGuHgdbQXASSQb-2" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="387" y="595" as="sourcePoint" />
            <mxPoint x="437" y="545" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-7" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="60" y="521" as="sourcePoint" />
            <mxPoint x="620" y="521" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-8" value="Handshake Initiation" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="250" y="491" width="158" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-12" value="0x1(1bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="640" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-13" value="reserved (3bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="260" y="640" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-14" value="sender_index(4bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="670" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-15" value="&amp;nbsp;unencrypted_ephemeral (32bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="700" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-16" value="encrypted_static (32bytes+16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="730" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-17" value="encrypted_timestamp (12bytes+16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="760" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-18" value="mac1 (16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="790" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-19" value="mac2 (16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="340" y="790" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-20" value="静态公私钥" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry y="280" width="680" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-24" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="60" y="320" as="sourcePoint" />
            <mxPoint x="60" y="350" as="targetPoint" />
            <Array as="points">
              <mxPoint x="100" y="320" />
              <mxPoint x="100" y="350" />
              <mxPoint x="80" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-25" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="620" y="320" as="sourcePoint" />
            <mxPoint x="620" y="350" as="targetPoint" />
            <Array as="points">
              <mxPoint x="660" y="320" />
              <mxPoint x="660" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-26" value="static key pair（S_pirv_i，S_pub_i）" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="110" y="320" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-27" value="static key pair（S_pirv_r，S_pub_r）" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="670" y="320" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-28" value="Initiation阶段" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry y="380" width="680" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-27" target="SK4sQwNGuHgdbQXASSQb-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-32" value="&lt;div&gt;发起方&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;发送Initiation报文&lt;/span&gt;&lt;/div&gt;Generate Ephemeral E_i（生成临时密钥）:E_priv_i、E_pub_i&lt;div&gt;DH1 = DH(E_priv_i, S_pub_r)&lt;/div&gt;&lt;div&gt;DH2 = DH(S_priv_i, S_pub_r)&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-280" y="421" width="340" height="70" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-34" value="&lt;div&gt;S_priv_i / S_pub_i ：Initiator 静态私钥 / 公钥&lt;/div&gt;&lt;div&gt;S_priv_r / S_pub_r ：Responder 静态私钥 / 公钥&lt;/div&gt;&lt;div&gt;E_priv_i / E_pub_i ：Initiator 临时私钥 / 公钥&lt;/div&gt;&lt;div&gt;E_priv_r / E_pub_r ：Responder 临时私钥 / 公钥&lt;/div&gt;&lt;div&gt;Q：对称的共享密钥&lt;/div&gt;&lt;div&gt;ChaCha20-Poly1305：输出ciphertext || tag&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;ciphertext = ChaCha20(plaintext) （密文）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; tag= Poly1305( key_auth , AAD || ciphertext )&amp;nbsp; （认证标签）&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="180" y="110" width="336" height="140" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-38" value="&lt;div&gt;发起端随机生成&lt;/div&gt;&lt;div&gt;用于：&lt;/div&gt;&lt;div&gt;&amp;nbsp;标识本次握手上下文&lt;/div&gt;&lt;div&gt;&amp;nbsp;后续 Response 引用&lt;/div&gt;" style="rounded=1;arcSize=9;align=left;spacingLeft=5;strokeColor=#4C9AFF;html=1;strokeWidth=2;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="155" y="570" width="130" height="61" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-39" value="发起端临时公钥：&lt;span style=&quot;text-wrap: wrap;&quot;&gt;E_pub_i&lt;/span&gt;" style="rounded=1;arcSize=9;align=left;spacingLeft=5;strokeColor=#4C9AFF;html=1;strokeWidth=2;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="144.5" y="530" width="151" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-40" value="" style="endArrow=none;html=1;rounded=0;endFill=0;startArrow=classic;startFill=1;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="60" y="953" as="sourcePoint" />
            <mxPoint x="620" y="953" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-41" value="Handshake Response" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="250" y="923" width="158" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-42" value="0x2(1bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1009" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-43" value="reserved (3bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="240" y="1009" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-44" value="sender_index(4bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1039" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-45" value="receiver_index(4bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1069" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-46" value="unencrypted_ephemeral&amp;nbsp;(32bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1099" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-47" value="encrypted_nothing (0bytes+16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1129" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-48" value="mac1 (16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1159" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-49" value="mac2 (16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="320" y="1159" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-50" value="&lt;div&gt;响应方处理Initiation报文&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;DH1 = DH(S_priv_r, E_pub_i)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;DH2 = DH(S_priv_r, S_pub_i)&lt;br&gt;&lt;/div&gt;&lt;div&gt;双方计算出来的DH1和DH2一样，&lt;/div&gt;&lt;div&gt;因此响应按照相反流程解密static和timestamp&lt;/div&gt;&lt;div&gt;生成&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;H_r和&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;C_r&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(204, 0, 0); text-align: center;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(204, 0, 0); text-align: center;&quot;&gt;encrypted_static&lt;/span&gt;&lt;span style=&quot;text-align: center;&quot;&gt;&lt;font style=&quot;color: rgb(0, 0, 51);&quot;&gt;的作用：&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;绑定且隐藏了&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;S_pub_i，且参与生成&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;H_i&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;H_i用于生成&lt;span style=&quot;color: rgb(204, 0, 0); text-align: center; background-color: transparent;&quot;&gt;encrypted_timestamp，&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;color: rgb(0, 0, 51);&quot;&gt;&lt;span style=&quot;text-align: center; background-color: transparent; color: rgb(204, 0, 0);&quot;&gt;增加了&lt;/span&gt;&lt;span style=&quot;text-align: center; background-color: transparent; color: rgb(204, 0, 0);&quot;&gt;encrypted_timestamp的安全性&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="620" y="451" width="270" height="169" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-57" value="&lt;div&gt;响应方发送Response报文&lt;/div&gt;Generate Ephemeral E_r（生成临时密钥）:E_priv_r、E_pub_r&lt;div&gt;DH3 = DH(E_priv_r, E_pub_i)&lt;/div&gt;&lt;div&gt;DH4 = DH(E_priv_r, S_pub_i)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="620" y="953" width="350" height="67" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-58" value="&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;发起方处理Response报文&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;DH3 = DH(E_priv_i, E_pub_r)&lt;br&gt;&lt;div&gt;DH4 = DH(S_priv_i, E_pub_r)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;双方计算出来的DH3和DH4一样，&lt;/div&gt;&lt;div&gt;因此响应按照相反流程解密&lt;span style=&quot;text-align: center; background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;encrypted_nothing&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-210" y="953" width="270" height="87" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-59" value="会话密钥派生" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry y="1213" width="680" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-61" value="{K_tx_i, K_rx_i} = KDF2(C_i)" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=15;fontColor=#CC0000;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="80" y="1253" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-62" value="{K_tx_r, K_rx_r} = KDF2(C_r)" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=15;fontColor=#CC0000;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="400" y="1253" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-66" value="K_tx_i = K_rx_r&lt;div&gt;K_rx_i = K_tx_r&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=18;fontColor=#CC0000;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="220" y="1288" width="200" height="70" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-68" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" target="SK4sQwNGuHgdbQXASSQb-38" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="180" y="685" as="sourcePoint" />
            <mxPoint x="420" y="760" as="targetPoint" />
            <Array as="points">
              <mxPoint x="120" y="685" />
              <mxPoint x="120" y="601" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-69" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-39" target="SK4sQwNGuHgdbQXASSQb-15" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="90" y="679.5" as="sourcePoint" />
            <mxPoint x="140" y="629.5" as="targetPoint" />
            <Array as="points">
              <mxPoint x="100" y="545" />
              <mxPoint x="100" y="715" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-70" value="数据报文" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry y="1388" width="680" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-71" value="0x4(1bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1428" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-72" value="reserved (3bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="240" y="1428" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-73" value="receiver_index(4bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1458" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-74" value="counter(8bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1488" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-75" value="encrypted_data&amp;nbsp;([])" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="160" y="1518" width="320" height="70" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-80" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.75;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-84" target="SK4sQwNGuHgdbQXASSQb-17" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="40" y="675" as="sourcePoint" />
            <mxPoint x="190" y="625" as="targetPoint" />
            <Array as="points">
              <mxPoint x="110" y="775" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-82" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-85" target="SK4sQwNGuHgdbQXASSQb-47" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-890" y="1114" as="sourcePoint" />
            <mxPoint x="-430" y="1083" as="targetPoint" />
            <Array as="points">
              <mxPoint x="580" y="1140" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-84" value="&lt;div&gt;CONSTRUCTION = &quot;Noise_IKpsk2_25519_ChaChaPoly_BLAKE2s&quot;&lt;br&gt;&lt;/div&gt;&lt;div&gt;IDENTIFIER = &quot;WireGuard v1 zx2c4 Jason@zx2c4.com&quot;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;C_i := HASH(CONSTRUCTION)&lt;/div&gt;&lt;div&gt;H_i := HASH(C_i || IDENTIFIER)&lt;/div&gt;&lt;div&gt;H_i := HASH(H_i ||&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;S_pub_r)&amp;nbsp; &amp;gt;&amp;gt; R静态公钥&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;C_i =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;KDF1(&lt;/span&gt;C_i&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;,&amp;nbsp;&lt;/span&gt;E_pub_i&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;H_i := HASH(H_i ||&amp;nbsp;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;msg.&lt;/span&gt;&lt;span style=&quot;text-align: center; background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ephemeral&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;) =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;HASH(H_i ||&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;E_pub_i) &amp;gt;&amp;gt; I临时公钥&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;C_i,k&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&amp;nbsp;= KDF2(&lt;/span&gt;C_i&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;, DH1)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;ciphertext = AEAD(k, nonce=0, aad=H_i, plaintext=S_pub_i&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(32bytes)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;gt;&amp;gt;I静态公钥&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;text-align: center;&quot;&gt;&lt;font style=&quot;color: rgb(204, 0, 0);&quot;&gt;encrypted_static&lt;/font&gt;&amp;nbsp; =&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ciphertext&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(32B 密文 + 16B tag)&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;H_i :=&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(&lt;/span&gt;H_i&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;||&lt;/span&gt;&lt;span style=&quot;text-align: center;&quot;&gt;&lt;font style=&quot;color: rgb(0, 0, 51);&quot;&gt;encrypted_static&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;C_i,k&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&amp;nbsp;= KDF2(&lt;/span&gt;C_i&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;, DH2)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;ciphertext2 = AEAD(k, nonce=0, aad=H_i&amp;nbsp;, plaintext=timestamp&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(12bytes)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;text-align: center;&quot;&gt;&lt;font style=&quot;color: rgb(204, 0, 0);&quot;&gt;encrypted_timestamp&lt;/font&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ciphertext2&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(12B 密文 + 16B tag)&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;H_i :=&amp;nbsp;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;(&lt;/span&gt;H_i&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&amp;nbsp;||&lt;/span&gt;&lt;font style=&quot;color: rgb(0, 0, 51);&quot;&gt;&lt;font style=&quot;text-align: center;&quot;&gt;encrypted_timestamp&lt;/font&gt;&lt;span style=&quot;text-align: center;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-380" y="491" width="440" height="243.12" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-85" value="&lt;div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;C_r =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;KDF1(&lt;/span&gt;C_r&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;,&amp;nbsp;&lt;/span&gt;E_pub_r&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;)&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;gt;&amp;gt; R临时公钥&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;H_r := HASH(H_r ||&amp;nbsp;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;msg.&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent; text-align: center;&quot;&gt;ephemeral&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;) =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;HASH(H_r ||&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;E_pub_r) &amp;gt;&amp;gt; R临时公钥&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;C_r,k&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&amp;nbsp;= KDF1(&lt;/span&gt;C_r&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;, DH3)&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;C_r,k&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&amp;nbsp;= KDF1(&lt;/span&gt;C_r&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;, DH4)&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;(C_r, τ,&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;k&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;) := KDF3(C_r, Q)&amp;nbsp; &amp;gt;&amp;gt;预共享密钥&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;H_r := HASH(H_r || τ)&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ciphertext3 = AEAD(k, nonce=0, aad=H_r, plaintext=&quot;&quot;)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;text-align: center;&quot;&gt;&lt;font style=&quot;color: rgb(204, 0, 0);&quot;&gt;encrypted_nothing&lt;/font&gt; =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ciphertext3&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(0B 密文 + 16B tag)&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;H_r&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;HASH&lt;span style=&quot;background-color: transparent;&quot;&gt;(&lt;/span&gt;H_r&lt;span style=&quot;background-color: transparent;&quot;&gt;&amp;nbsp;||&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center;&quot;&gt;encrypted_nothing&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="620" y="1020" width="440" height="157" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-86" value="&lt;div&gt;&lt;div&gt;ciphertext = ChaCha20-Poly1305(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; key&amp;nbsp; &amp;nbsp;= K_tx,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; nonce = counter,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; aad&amp;nbsp; &amp;nbsp;= NULL,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; plaintext = inner_packet&lt;/div&gt;&lt;div&gt;)&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: center;&quot;&gt;encrypted_data&amp;nbsp;([]) =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;ciphertext || 16-byte tag&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;明文长度 =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;inner_packet 长度&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;加密后长度 =&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;len(ciphertext) = len(plaintext) +&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;len(tag) = 16&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-310" y="1443" width="340" height="147" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-87" value="&lt;div&gt;mac1_key = HASH(&quot;mac1----&quot; || S_pub_receiver)&amp;nbsp; &amp;nbsp; 32 bytes → 截断为 16 bytes&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Initiation 报文 → 使用 Responder 的 S_pub_r&lt;/div&gt;&lt;div&gt;Response 报文 → 使用 Initiator 的 S_pub_i&lt;/div&gt;&lt;/div&gt;&lt;div&gt;mac1_key 绑定“接收方”的身份。&lt;/div&gt;&lt;div&gt;mac1 =&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;MAC(key = mac1_key,data = msg(整个握手报文))[0:16]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;响应方一样计算，比较前16B，由于有&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;S_pub_receiver参与计算&lt;/span&gt;&lt;/div&gt;&lt;div&gt;解决： 1.随机扫描攻击无法通过 ；2.CPU不会浪费在DH上&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-400" y="754.5" width="460" height="131" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-89" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-87" target="SK4sQwNGuHgdbQXASSQb-18" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="50" y="760" as="sourcePoint" />
            <mxPoint x="190" y="760" as="targetPoint" />
            <Array as="points">
              <mxPoint x="120" y="820" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-90" value="mac2 在触发 DoS 防护时启用&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;响应发填写：&lt;/div&gt;&lt;div&gt;mac2_key =&amp;nbsp;cookie_secret (周期轮换, 2mins)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;τ&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;MAC(key = mac2_key,data = sip||sport)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;text-align: center; background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;encrypted_cookie = XAead(HASH(&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&quot;cookie--&quot; || S_pub_receiver&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); text-align: center;&quot;&gt;),nonce,&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;τ, mac1&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); text-align: center;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;发起方填写：&lt;/div&gt;&lt;div&gt;mac2 =&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;MAC(key = cookie,data = msg(整个握手报文))[0:16]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;mac能&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;减少昂贵的DH计算；是握手前的过滤层&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="620" y="636" width="440" height="173" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-91" value="0x3(1bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="805" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-92" value="reserved (3bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="700" y="805" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-93" value="receiver_index(4bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="835" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-94" value="&amp;nbsp;nonce (24bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="865" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-95" value="encrypted_cookie (16bytes+16bytes)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="895" width="320" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-100" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-19" target="SK4sQwNGuHgdbQXASSQb-90" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="414" y="805" as="sourcePoint" />
            <mxPoint x="640" y="690" as="targetPoint" />
            <Array as="points">
              <mxPoint x="580" y="805" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-101" value="&lt;div&gt;&lt;div&gt;发送方向的单调递增计数器&lt;/div&gt;&lt;/div&gt;&lt;div&gt;每发送一个数据包：counter++&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;作为 AEAD nonce&lt;/div&gt;&lt;div&gt;防止重放攻击&lt;/div&gt;&lt;div&gt;提供唯一性保证&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="637" y="1450" width="179" height="106" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-102" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-75" target="SK4sQwNGuHgdbQXASSQb-86" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="408" y="1735" as="sourcePoint" />
            <mxPoint x="248" y="1750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-103" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-101" target="SK4sQwNGuHgdbQXASSQb-74" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="990" y="1325" as="sourcePoint" />
            <mxPoint x="830" y="1340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-104" value="&lt;div&gt;&lt;span class=&quot;fontstyle0&quot;&gt;Initiator&lt;/span&gt;&lt;br style=&quot;font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-variant-position: normal; line-height: normal; text-align: -webkit-auto; text-size-adjust: auto;&quot;&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-71" y="-169" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-105" value="&lt;span class=&quot;fontstyle0&quot;&gt;Responder&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="169" y="-169" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-110" value="&lt;div&gt;&lt;span class=&quot;fontstyle0&quot;&gt;Initiator&lt;/span&gt;&lt;br style=&quot;font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-variant-position: normal; line-height: normal; text-align: -webkit-auto; text-size-adjust: auto;&quot;&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-71" y="-9" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-111" value="&lt;span class=&quot;fontstyle0&quot;&gt;Responder&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="169" y="-9" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-117" value="" style="endArrow=none;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-111" target="SK4sQwNGuHgdbQXASSQb-105" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-141" y="21" as="sourcePoint" />
            <mxPoint x="-91" y="-29" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-118" value="" style="endArrow=none;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-110" target="SK4sQwNGuHgdbQXASSQb-104" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-141" y="21" as="sourcePoint" />
            <mxPoint x="-91" y="-29" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-119" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-11" y="-109" as="sourcePoint" />
            <mxPoint x="229" y="-109" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-120" value="Handshake Initiation" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="39" y="-129" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-123" value="Handshake Response" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="39" y="-99" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-124" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="229" y="-79" as="sourcePoint" />
            <mxPoint x="-11" y="-79" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-126" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="-11" y="-49" as="sourcePoint" />
            <mxPoint x="229" y="-49" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-127" value="Transport Data" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="39" y="-69" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-128" value="Transport Data" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="39" y="-39" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-129" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="229" y="-19" as="sourcePoint" />
            <mxPoint x="-11" y="-19" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-130" value="&lt;div&gt;&lt;span class=&quot;fontstyle0&quot;&gt;Initiator&lt;/span&gt;&lt;br style=&quot;font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-variant-position: normal; line-height: normal; text-align: -webkit-auto; text-size-adjust: auto;&quot;&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="369" y="-190" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-131" value="&lt;span class=&quot;fontstyle0&quot;&gt;Responder&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="609" y="-190" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-132" value="&lt;div&gt;&lt;span class=&quot;fontstyle0&quot;&gt;Initiator&lt;/span&gt;&lt;br style=&quot;font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-variant-position: normal; line-height: normal; text-align: -webkit-auto; text-size-adjust: auto;&quot;&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="369" y="32" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-133" value="&lt;span class=&quot;fontstyle0&quot;&gt;Responder&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="609" y="32" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-134" value="" style="endArrow=none;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-133" target="SK4sQwNGuHgdbQXASSQb-131" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="299" as="sourcePoint" />
            <mxPoint x="349" y="-50" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-135" value="" style="endArrow=none;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="SK4sQwNGuHgdbQXASSQb-132" target="SK4sQwNGuHgdbQXASSQb-130" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="299" as="sourcePoint" />
            <mxPoint x="349" y="-50" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-136" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="429" y="-130" as="sourcePoint" />
            <mxPoint x="669" y="-130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-137" value="Handshake Initiation" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="479" y="-150" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-138" value="Cookie Reply" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="479" y="-120" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-139" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="669" y="-100" as="sourcePoint" />
            <mxPoint x="429" y="-100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-140" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="429" y="-10" as="sourcePoint" />
            <mxPoint x="669" y="-10" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-141" value="Transport Data" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="479" y="-30" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-142" value="Transport Data" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="479" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-143" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="669" y="20" as="sourcePoint" />
            <mxPoint x="429" y="20" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-147" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="429" y="-70" as="sourcePoint" />
            <mxPoint x="669" y="-70" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-148" value="Handshake Initiation" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="479" y="-90" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-149" value="Handshake Response" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="479" y="-60" width="158" height="20" as="geometry" />
        </mxCell>
        <mxCell id="SK4sQwNGuHgdbQXASSQb-150" value="" style="endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="669" y="-40" as="sourcePoint" />
            <mxPoint x="429" y="-40" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="bl4TCUeoO--Wx97AP43a-1" value="响应端临时公钥：&lt;span style=&quot;text-wrap: wrap;&quot;&gt;E_pub_r&lt;/span&gt;" style="rounded=1;arcSize=9;align=left;spacingLeft=5;strokeColor=#4C9AFF;html=1;strokeWidth=2;fontSize=12" vertex="1" parent="1">
          <mxGeometry x="300" y="963" width="161" height="30" as="geometry" />
        </mxCell>
        <mxCell id="bl4TCUeoO--Wx97AP43a-2" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;rounded=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="bl4TCUeoO--Wx97AP43a-1" target="SK4sQwNGuHgdbQXASSQb-46">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="640" y="1105" as="sourcePoint" />
            <mxPoint x="490" y="1138" as="targetPoint" />
            <Array as="points">
              <mxPoint x="520" y="978" />
              <mxPoint x="520" y="1114" />
            </Array>
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
